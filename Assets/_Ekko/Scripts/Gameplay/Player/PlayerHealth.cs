using UnityEngine;
using UnityEngine.Events;

/// <summary>
/// G√®re la "vie" du joueur sous forme de lumi√®re.
/// Appelle des √©v√©nements quand la lumi√®re change, devient faible ou tombe √† z√©ro.
/// </summary>
public class PlayerHealth : MonoBehaviour
{
    [Header("Lumi√®re/Vie")]
    [SerializeField] private float maxLight = 100f;
    [SerializeField] private float currentLight;

    [Header("Seuil critique")]
    [SerializeField] private float lowLightThreshold = 20f;

    [Header("Events")]
    public UnityEvent onLightChanged;           // Appel√© √† chaque changement de lumi√®re (d√©g√¢ts ou soin)
    public UnityEvent onLowLight;               // Appel√© quand la lumi√®re passe sous le seuil critique
    public UnityEvent onDeath;

    private bool hasTriggeredFirstDamageQuote = false;                  

    // --- GETTERS PUBLICS ---
    public float CurrentLight => currentLight;
    public float MaxLight => maxLight;
    public bool IsDead => currentLight <= 0f;
    public bool IsLow => currentLight <= lowLightThreshold;

    private void Awake()
    {
        // Initialisation max light
        currentLight = maxLight;
    }

    private void Update()
    {

    }

    // --- M√âTHODES DE TEST RAPIDES ---
    [ContextMenu("Test: Restore Light (30)")]
    private void TestRestoreLight()
    {
        RestoreLight(30f);
        Debug.Log("[PlayerHealth] TestRestoreLight: +30");
    }

    public void TakeDamage(float amount)
    {
        if (IsDead)
            return;

        // R√©duction de lumi√®re
        currentLight -= amount;
        currentLight = Mathf.Clamp(currentLight, 0f, maxLight);     // √âvite d‚Äôaller en n√©gatif

        Debug.Log($"[PlayerHealth] üí• D√©g√¢ts re√ßus : -{amount} | Lumi√®re restante : {currentLight} | IsDead = {IsDead}");

        if (!hasTriggeredFirstDamageQuote)
        {
            hasTriggeredFirstDamageQuote = true;

            // Affiche une citation Tip li√©e aux d√©g√¢ts (tag personnalis√©)
            QuoteManager.Instance?.ShowRandomQuote(QuoteType.Tip, QuoteTag.Diversion);

            // Tu peux changer le tag en QuoteTag.FirstDamage si tu en cr√©es un
        }

        onLightChanged?.Invoke();   // Notifie tout syst√®me √©coutant ce changement (UI, shader, etc.)

        if (IsLow)
        {
            Debug.Log("[PlayerHealth] ‚ö†Ô∏è Lumi√®re critique !");
            onLowLight?.Invoke();
        }

        if (IsDead)
        {
            Debug.Log("[PlayerHealth] ‚ò†Ô∏è Le joueur est mort.");
            onDeath?.Invoke();
            HandleDeath();  // Appelle GameManager pour g√©rer la mort (Game Over, respawn, etc.)
        }
    }

    /// <summary>
    /// R√©initialise la lumi√®re au maximum (utile apr√®s un respawn ou une transition).
    /// </summary>
    public void ResetHealth()
    {
        //Debug.Log("[PlayerHealth] üîÅ Reset de la lumi√®re");
        currentLight = maxLight;
        onLightChanged?.Invoke();
    }

    /// <summary>
    /// Restaure de la lumi√®re (√©quivalent d‚Äôun soin ou d‚Äôun bonus lumineux).
    /// </summary>
    public void RestoreLight(float amount)
    {
        currentLight += amount;
        currentLight = Mathf.Clamp(currentLight, 0f, maxLight);
        onLightChanged?.Invoke();
    }

    /// <summary>
    /// D√©finir manuellement la lumi√®re (debug, chargement de sauvegarde, effet sp√©cial).
    /// </summary>
    public void SetLight(float value) // Cas d'usage : R√©initialisation, Effets de script/Debug, Chargement de sauvegarde, Pouvoir sp√©cial/Sc√®ne narrative
    {
        currentLight = Mathf.Clamp(value, 0f, maxLight);
        Debug.Log($"[PlayerHealth] üîß Lumi√®re d√©finie manuellement : {currentLight}");
        onLightChanged?.Invoke();
    }

    /// <summary>
    /// Retourne un ratio entre 0 et 1 pour repr√©senter visuellement la lumi√®re (utile en UI).
    /// </summary>
    public float GetLightRatio()
    {
        return currentLight / maxLight;
    }

    /// <summary>
    /// G√®re la mort du joueur via le GameManager.
    /// </summary>
    private void HandleDeath()
    {

        if (GameManager.Instance != null)
        {
            GameManager.Instance.HandlePlayerDeath();
        }
        else
        {
            Debug.LogWarning("[PlayerHealth] GameManager.Instance est null !");
        }
    }
}